# 2단계: Clear 기능 구현 상세 계획

## 목적
Feature Store의 모든 데이터를 삭제하여 빈 상태로 만드는 기능

## 요구사항
1. **온라인 스토어 삭제**: 모든 레코드 삭제
2. **오프라인 스토어 삭제**: S3 데이터 삭제
3. **선택적 삭제**: 온라인만, 오프라인만, 또는 둘 다
4. **안전장치**: 확인 프롬프트, 백업 옵션
5. **진행상황 표시**: 삭제 진행률 표시

## CLI 인터페이스 설계

### 기본 명령어
```bash
sagemaker-fs clear <feature-group-name> [OPTIONS]
```

### 옵션들
- `--online-only`: 온라인 스토어만 삭제
- `--offline-only`: 오프라인 스토어만 삭제  
- `--force`: 확인 프롬프트 없이 즉시 삭제
- `--backup-s3 <s3-path>`: 삭제 전 S3에 백업
- `--dry-run`: 실제 삭제 없이 계획만 확인

### 예시
```bash
# 모든 데이터 삭제 (확인 프롬프트 표시)
sagemaker-fs clear my-feature-group

# 온라인 스토어만 삭제
sagemaker-fs clear my-feature-group --online-only

# 백업 후 삭제
sagemaker-fs clear my-feature-group --backup-s3 s3://my-backup/fg-backup/

# 강제 삭제 (확인 없음)
sagemaker-fs clear my-feature-group --force
```

## 구현 설계

### 1. 파일 구조
```
src/sagemaker_fs_cli/commands/
└── clear_cmd.py              # 새로 생성
```

### 2. clear_cmd.py 구조
```python
def clear_feature_group(config, feature_group_name, **options):
    """메인 진입점"""
    
def _validate_feature_group(config, feature_group_name):
    """피처그룹 존재 및 설정 확인"""
    
def _confirm_deletion(feature_group_name, options):
    """사용자 확인 프롬프트"""
    
def _backup_to_s3(config, feature_group_name, backup_path):
    """S3 백업 생성"""
    
def _clear_online_store(config, feature_group_name):
    """온라인 스토어 데이터 삭제"""
    
def _clear_offline_store(config, feature_group_name):
    """오프라인 스토어 데이터 삭제"""
    
def _get_all_record_ids(config, feature_group_name):
    """모든 레코드 ID 조회 (온라인 스토어 삭제용)"""
```

### 3. CLI 통합 (cli.py에 추가)
```python
@cli.command('clear')
@click.argument('feature_group_name')
@click.option('--online-only', is_flag=True, help='온라인 스토어만 삭제')
@click.option('--offline-only', is_flag=True, help='오프라인 스토어만 삭제')
@click.option('--force', is_flag=True, help='확인 없이 즉시 삭제')
@click.option('--backup-s3', help='삭제 전 S3 백업 경로')
@click.option('--dry-run', is_flag=True, help='실제 삭제 없이 계획만 확인')
@click.pass_context
def clear_feature_group(ctx, feature_group_name, online_only, offline_only, force, backup_s3, dry_run):
    """피처 그룹의 모든 데이터 삭제"""
```

## 핵심 구현 로직

### 1. 온라인 스토어 삭제
**도전과제**: SageMaker FeatureStore에는 "모든 레코드 삭제" API가 없음

**해결책**: 
1. **방법 1 (권장)**: Athena를 통해 모든 record_id 조회 후 배치 삭제
2. **방법 2**: 사용자가 제공한 record_id 목록으로 삭제
3. **방법 3**: Feature Group 재생성 (가장 확실하지만 위험)

**구현**:
```python
def _clear_online_store(config, feature_group_name):
    # 1. Athena를 통해 모든 record_id 조회
    query = f"SELECT {record_id_feature} FROM {athena_table}"
    record_ids = _execute_athena_query(config, query)
    
    # 2. 배치로 레코드 삭제 (DeleteRecord API 사용)
    for batch in _batch_records(record_ids, batch_size=25):
        for record_id in batch:
            config.featurestore_runtime.delete_record(
                FeatureGroupName=feature_group_name,
                RecordIdentifierValueAsString=str(record_id)
            )
```

### 2. 오프라인 스토어 삭제  
```python
def _clear_offline_store(config, feature_group_name, fg_details):
    # S3 경로 추출
    s3_config = fg_details['OfflineStoreConfig']['S3StorageConfig']
    s3_uri = s3_config['S3Uri']
    
    # S3 객체들 삭제
    s3_client = config.session.client('s3')
    bucket, prefix = _parse_s3_uri(s3_uri)
    
    paginator = s3_client.get_paginator('list_objects_v2')
    for page in paginator.paginate(Bucket=bucket, Prefix=prefix):
        if 'Contents' in page:
            objects = [{'Key': obj['Key']} for obj in page['Contents']]
            s3_client.delete_objects(
                Bucket=bucket,
                Delete={'Objects': objects}
            )
```

### 3. 백업 기능
```python
def _backup_to_s3(config, feature_group_name, backup_path, fg_details):
    # 오프라인 스토어 데이터를 백업 위치로 복사
    source_s3_uri = fg_details['OfflineStoreConfig']['S3StorageConfig']['S3Uri']
    
    # S3 to S3 복사
    s3_client = config.session.client('s3')
    # ... S3 복사 로직
```

### 4. 안전장치
```python
def _confirm_deletion(feature_group_name, options):
    if options.get('force'):
        return True
        
    stores_to_clear = []
    if options.get('online_only'):
        stores_to_clear.append("온라인 스토어")
    elif options.get('offline_only'):
        stores_to_clear.append("오프라인 스토어")
    else:
        stores_to_clear.extend(["온라인 스토어", "오프라인 스토어"])
    
    stores_str = ", ".join(stores_to_clear)
    
    click.echo(f"⚠️  경고: '{feature_group_name}'의 {stores_str} 데이터가 완전히 삭제됩니다.")
    click.echo("이 작업은 되돌릴 수 없습니다!")
    
    return click.confirm("정말로 계속하시겠습니까?")
```

## 에러 처리

### 1. API 제한 처리
```python
import time
from botocore.exceptions import ClientError

def _handle_throttling(func, *args, **kwargs):
    max_retries = 5
    base_delay = 1
    
    for attempt in range(max_retries):
        try:
            return func(*args, **kwargs)
        except ClientError as e:
            if e.response['Error']['Code'] == 'ThrottlingException':
                delay = base_delay * (2 ** attempt)
                time.sleep(delay)
                continue
            raise
```

### 2. 진행상황 표시
```python
from tqdm import tqdm

def _delete_records_with_progress(config, feature_group_name, record_ids):
    with tqdm(total=len(record_ids), desc="레코드 삭제 중") as pbar:
        for record_id in record_ids:
            _handle_throttling(
                config.featurestore_runtime.delete_record,
                FeatureGroupName=feature_group_name,
                RecordIdentifierValueAsString=str(record_id)
            )
            pbar.update(1)
```

## 구현 단계

### Step 1: clear_cmd.py 기본 구조 생성
- 파일 생성 및 기본 함수들 구현
- 피처그룹 검증 로직

### Step 2: 온라인 스토어 삭제 구현
- Athena 쿼리를 통한 record_id 조회
- 배치 삭제 로직

### Step 3: 오프라인 스토어 삭제 구현  
- S3 객체 삭제 로직

### Step 4: 백업 기능 구현
- S3 to S3 복사

### Step 5: CLI 통합
- cli.py에 clear 명령어 추가

### Step 6: 안전장치 및 UX 개선
- 확인 프롬프트, 진행률 표시

## 테스트 계획

### 1. 단위 테스트
- 각 함수별 개별 테스트
- Mock을 사용한 AWS API 테스트

### 2. 통합 테스트  
- 테스트용 피처그룹으로 전체 플로우 테스트

### 3. 에러 케이스 테스트
- 존재하지 않는 피처그룹
- 권한 부족
- API 제한 시나리오

## 위험도 및 고려사항

### 위험도: 높음
- **데이터 손실**: 실수로 중요한 데이터 삭제 가능
- **비가역성**: 삭제된 데이터 복구 불가능

### 완화 방안
1. **다중 확인**: force 플래그 없으면 반드시 확인
2. **Dry-run 모드**: 실제 실행 전 계획 확인  
3. **백업 옵션**: 삭제 전 자동 백업
4. **상세 로깅**: 모든 삭제 작업 로그 기록

## 필요한 의존성
```python
# 추가 패키지 (requirements.txt)
tqdm>=4.65.0  # 진행률 표시
```

이 계획으로 구현을 진행할까요?