# 2. create - 피처 그룹 생성

## 개요
새로운 SageMaker Feature Group을 생성합니다. Online Store, Offline Store, TTL 설정 등 다양한 옵션을 지원합니다.

## 기본 사용법
```bash
fs create FEATURE_GROUP_NAME [OPTIONS]
```

## 필수 옵션
- `--schema-file PATH`: 스키마 정의 JSON 파일 경로 (필수)
- `--role-arn TEXT`: IAM 역할 ARN (필수)

## 선택 옵션

### 기본 설정
- `--description TEXT`: Feature Group 설명
- `--record-identifier-name TEXT`: 레코드 식별자 필드명 (기본값: id)
- `--event-time-feature-name TEXT`: 이벤트 시간 필드명 (기본값: event_time)

### 스토어 설정
- `--online-store/--no-online-store`: Online Store 활성화 여부 (기본값: True)
- `--offline-store/--no-offline-store`: Offline Store 활성화 여부 (기본값: True)
- `--s3-uri TEXT`: Offline Store S3 URI (offline store 사용시 필수)
- `--ttl-duration INTEGER`: Online Store TTL 기간 (단위: 일, 1-365일)

### 보안 설정
- `--enable-encryption/--no-encryption`: 암호화 활성화 여부 (기본값: False)
- `--kms-key-id TEXT`: KMS 키 ID (암호화 사용시)

### 고급 설정
- `--table-format [Iceberg|Glue]`: 테이블 형식 (기본값: Glue)
- `--throughput-mode [OnDemand|Provisioned]`: 처리량 모드 (기본값: OnDemand)
- `--read-capacity-units INTEGER`: 읽기 용량 단위 (Provisioned 모드에서만)
- `--write-capacity-units INTEGER`: 쓰기 용량 단위 (Provisioned 모드에서만)

### 메타데이터
- `--tags TEXT`: 태그 (key=value 형식, 다중 지정 가능)
- `--wait/--no-wait`: 생성 완료까지 대기 여부 (기본값: True)

## 스키마 파일 형식

### 기본 스키마 예시 (schema.json)
```json
[
  {
    "FeatureName": "customer_id",
    "FeatureType": "String"
  },
  {
    "FeatureName": "event_time",
    "FeatureType": "String"
  },
  {
    "FeatureName": "age",
    "FeatureType": "Integral"
  },
  {
    "FeatureName": "balance",
    "FeatureType": "Fractional"
  },
  {
    "FeatureName": "category",
    "FeatureType": "String"
  }
]
```

### 고급 스키마 예시 (벡터 지원)
```json
[
  {
    "FeatureName": "customer_id",
    "FeatureType": "String"
  },
  {
    "FeatureName": "embedding",
    "FeatureType": "String",
    "CollectionType": "List",
    "CollectionConfig": {
      "VectorConfig": {
        "Dimension": 128
      }
    }
  },
  {
    "FeatureName": "tags",
    "FeatureType": "String",
    "CollectionType": "Set"
  }
]
```

### 지원하는 FeatureType
- `String`: 문자열 데이터
- `Integral`: 정수형 데이터 (int, long)
- `Fractional`: 실수형 데이터 (float, double)

## 상세 사용 예시

### 1. 기본 Feature Group 생성
```bash
fs create customer-profile \
  --schema-file customer_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --s3-uri s3://my-feature-store-bucket/customer-data/ \
  --description "고객 프로필 데이터"
```

### 2. Online Store만 활성화
```bash
fs create real-time-features \
  --schema-file realtime_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --no-offline-store \
  --description "실시간 추론용 피처"
```

### 3. TTL 설정 (자동 만료)
```bash
fs create session-features \
  --schema-file session_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --s3-uri s3://my-feature-store-bucket/session-data/ \
  --ttl-duration 7 \
  --description "7일 후 자동 삭제되는 세션 데이터"
```

### 4. 암호화 활성화
```bash
fs create sensitive-data \
  --schema-file sensitive_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --s3-uri s3://my-feature-store-bucket/sensitive-data/ \
  --enable-encryption \
  --kms-key-id alias/sagemaker-key \
  --description "암호화된 민감 데이터"
```

### 5. Provisioned 모드 (고정 용량)
```bash
fs create high-throughput-features \
  --schema-file throughput_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --s3-uri s3://my-feature-store-bucket/high-throughput/ \
  --throughput-mode Provisioned \
  --read-capacity-units 100 \
  --write-capacity-units 50 \
  --description "고처리량 피처 그룹"
```

### 6. Iceberg 테이블 형식 (고급 기능)
```bash
fs create analytics-features \
  --schema-file analytics_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --s3-uri s3://my-feature-store-bucket/analytics/ \
  --table-format Iceberg \
  --description "분석용 Iceberg 테이블"
```

### 7. 태그와 함께 생성
```bash
fs create production-features \
  --schema-file prod_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --s3-uri s3://my-feature-store-bucket/production/ \
  --tags environment=production \
  --tags team=ml-platform \
  --tags cost-center=ai-research \
  --description "프로덕션 환경 피처"
```

### 8. 사용자 정의 식별자 및 이벤트 시간
```bash
fs create user-activity \
  --schema-file activity_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --s3-uri s3://my-feature-store-bucket/activity/ \
  --record-identifier-name user_id \
  --event-time-feature-name activity_timestamp \
  --description "사용자 활동 로그"
```

### 9. 백그라운드에서 생성 (비동기)
```bash
fs create background-features \
  --schema-file bg_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --s3-uri s3://my-feature-store-bucket/background/ \
  --no-wait \
  --description "백그라운드에서 생성"
```

### 10. 최대 TTL (1년) 설정
```bash
fs create long-term-features \
  --schema-file longterm_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --s3-uri s3://my-feature-store-bucket/longterm/ \
  --ttl-duration 365 \
  --description "1년 보관 데이터"
```

## 고급 사용 시나리오

### 1. 멀티 리전 배포
```bash
# 여러 리전에 동일한 Feature Group 생성
for region in us-east-1 us-west-2 ap-northeast-2; do
  fs --region $region create global-features-$region \
    --schema-file global_schema.json \
    --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
    --s3-uri s3://my-feature-store-$region/global/ \
    --description "글로벌 피처 ($region)"
done
```

### 2. 환경별 Feature Group 생성
```bash
# 개발, 스테이징, 프로덕션 환경별 생성
for env in dev staging prod; do
  fs create customer-features-$env \
    --schema-file customer_schema.json \
    --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole-$env \
    --s3-uri s3://feature-store-$env/customer/ \
    --tags environment=$env \
    --description "$env 환경 고객 피처"
done
```

### 3. 데이터 라이프사이클별 Feature Group
```bash
# 단기 (7일)
fs create short-term-features \
  --schema-file short_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --ttl-duration 7 \
  --no-offline-store \
  --description "단기 캐시 데이터"

# 중기 (30일)  
fs create medium-term-features \
  --schema-file medium_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --s3-uri s3://my-feature-store-bucket/medium/ \
  --ttl-duration 30 \
  --description "중기 보관 데이터"

# 장기 (무제한)
fs create long-term-features \
  --schema-file long_schema.json \
  --role-arn arn:aws:iam::123456789012:role/SageMakerExecutionRole \
  --s3-uri s3://my-feature-store-bucket/archive/ \
  --no-online-store \
  --description "장기 아카이브 데이터"
```

## 스키마 설계 모범 사례

### 1. 효율적인 스키마 구조
```json
[
  {
    "FeatureName": "pk_customer_id",
    "FeatureType": "String"
  },
  {
    "FeatureName": "sk_timestamp", 
    "FeatureType": "String"
  },
  {
    "FeatureName": "numerical_features",
    "FeatureType": "Fractional"
  },
  {
    "FeatureName": "categorical_features",
    "FeatureType": "String"
  },
  {
    "FeatureName": "boolean_flags",
    "FeatureType": "String"
  }
]
```

### 2. 벡터 임베딩을 위한 스키마
```json
[
  {
    "FeatureName": "item_id",
    "FeatureType": "String"
  },
  {
    "FeatureName": "item_embedding",
    "FeatureType": "String",
    "CollectionType": "List",
    "CollectionConfig": {
      "VectorConfig": {
        "Dimension": 768
      }
    }
  },
  {
    "FeatureName": "embedding_model_version",
    "FeatureType": "String"
  }
]
```

## 비용 최적화 전략

### 1. 스토어 타입별 비용 고려
```bash
# 실시간 추론만 필요한 경우 - Online Store만
fs create realtime-only \
  --no-offline-store \
  --ttl-duration 30

# 배치 분석만 필요한 경우 - Offline Store만  
fs create batch-only \
  --no-online-store

# 둘 다 필요한 경우 - 하이브리드
fs create hybrid-features \
  --ttl-duration 7  # Online Store는 짧게 유지
```

### 2. 처리량 모드 선택
```bash
# 예측 가능한 트래픽 - Provisioned (비용 절약)
fs create predictable-load \
  --throughput-mode Provisioned \
  --read-capacity-units 10 \
  --write-capacity-units 5

# 불규칙한 트래픽 - OnDemand (기본값)
fs create variable-load
  # OnDemand가 기본값
```

## 문제 해결

### 1. 권한 오류
```bash
# 오류: AccessDenied
# 필요한 IAM 권한:
# - sagemaker:CreateFeatureGroup
# - sagemaker:DescribeFeatureGroup  
# - iam:PassRole (지정된 역할에 대해)
# - s3:ListBucket, s3:GetObject, s3:PutObject (S3 URI에 대해)
```

### 2. 스키마 오류
```bash
# 오류: Invalid FeatureType
# 해결: String, Integral, Fractional만 지원
# 잘못된 예시: "FeatureType": "Integer"
# 올바른 예시: "FeatureType": "Integral"
```

### 3. TTL 설정 오류
```bash
# 오류: TtlDuration requires online store
# 해결: TTL은 Online Store가 활성화된 경우에만 설정 가능
fs create with-ttl \
  --online-store \  # Online Store 명시적 활성화
  --ttl-duration 30
```

### 4. 테이블 형식 호환성
```bash
# Iceberg vs Glue 선택 기준:
# - Glue: 단순하고 안정적, 레거시 호환성 좋음
# - Iceberg: 고급 기능(Time Travel, ACID), 성능 우수

# 호환성 문제 발생시 Glue 사용 권장
fs create compatible-features \
  --table-format Glue
```

## 모니터링 및 검증

### 1. 생성 상태 확인
```bash
# 생성 중인 Feature Group 모니터링
watch -n 5 'fs list | grep Creating'

# 특정 Feature Group 상태 확인
fs list -o json | jq '.[] | select(.FeatureGroupName=="my-feature-group")'
```

### 2. 생성 완료 후 검증
```bash
# 스키마 확인
fs schema my-feature-group

# 테스트 레코드 삽입
fs put my-feature-group --record '{"customer_id":"test", "event_time":"2024-01-01T00:00:00Z", "age":"25"}'

# 레코드 조회 테스트
fs get my-feature-group test
```

## 관련 명령어
- `fs list`: 생성된 Feature Group 확인
- `fs schema`: 스키마 정보 조회  
- `fs put`: 테스트 데이터 입력
- `fs delete`: Feature Group 삭제
- `fs schema-template`: 스키마 템플릿 생성